@page "/"
@using BlazorApp.Components.Base
@using System.Drawing;
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.PixelFormats
@inject NavigationManager NavigationManager
@inject ProtectedLocalStorage ProtectedLocalStore
@inject ProtectedSessionStorage ProtectedSessionStorage
@layout MainLayout
@inject BlazorApp.Data.LoadingService loadingService

<PageTitle>Blue Skies - Home</PageTitle>

<div class="fade-in-enter-active">
  @if (satteliteImageData != null)
  {
    <Image ImageName="@satteliteImageData" css=" w-full h-full object-cover" alt="Shapes"/>
  }
  else
  {
      <p>No satellite image available.</p>
  }

  @if (heightMapData != null)
  {
    <Image ImageName="@heightMapData" css=" w-full h-full object-cover" alt="Shapes"/>
  }
  else
  {
      <p>No height map available.</p>
  }

  @if (isLoaded){
    @if(isAd){
        loadingService.ShowLoadingScreen();
        NavigationManager.NavigateTo("/admin/keys");
    } else {
        <div class="w-full relative">
            <BlazorApp.Components.Home.Hero />

            @* How it works *@
            <Image ImageName="shapes.svg" css="absolute -top-64  -z-10 -left-1/2 w-2/3 h-2/3" alt="Shapes"/>
            <div class="mt-36 relative">
              <Image ImageName="Robert_Pointing.png" css="absolute top-0  -z-10  left-32 robert-slide-up h-72" alt="Rob"/>
              <BlazorApp.Components.Home.HowItWorks />
            </div>
            
            @* Unlock your full potential *@
            <BlazorApp.Components.Home.CTA />

            @* Frequently Asked Questions *@
            <div class="mt-72 lg:mt-44 mb-40 relative">
              <Image ImageName="shapes.svg" css="absolute -top-2/3 -z-20 -right-1/2 w-full h-full" alt="Shapes"/>
              <Image ImageName="Robert_Confused.png" css="absolute -top-32 z-20 right-16  h-80" alt="Rob"/>
              <Image ImageName="Panels.svg" css="absolute -top-20 -z-20 left-8" alt="Shapes"/>
            <BlazorApp.Components.Home.FAQ />
            </div>
        </div>
    }
  }
</div>


@code {
  private string? satteliteImageData;
  private string? heightMapData;
  private DataHandlers.RooftopDataHandler rooftopDataHandler = new DataHandlers.RooftopDataHandler();
  private bool isAd = false;
  private bool isLoaded = false;

/// <summary>
/// On page load, check if user is admin
/// </summary>
  protected override async Task OnInitializedAsync()
  {

    var isAdmin = await ProtectedLocalStore.GetAsync<bool>("isAdmin");
    await ProtectedSessionStorage.SetAsync("parent", "index");
    isAd = isAdmin.Value;
    isLoaded = true;
    loadingService.HideLoadingScreen();

    byte[] fileData;

    var fileLocation = "Pages/SatelliteImage";

    if (File.Exists(fileLocation))
    {
        using (var memoryStream = new MemoryStream())
        using (var fileStream = new FileStream(fileLocation, FileMode.Open, FileAccess.Read))
        {
            await fileStream.CopyToAsync(memoryStream);
            fileData = memoryStream.ToArray();
        }
        @* imageSrc = $"data:image/png;base64,{rooftopDataHandler.GetSatelliteImage(fileData)}";; *@
        satteliteImageData = rooftopDataHandler.GetSatelliteImage(fileData);
    }
    else
    {
        Console.WriteLine("File not found");
    }

    var heightMapLocation = "Pages/DSM";

    if (File.Exists(heightMapLocation))
    {
        heightMapData = rooftopDataHandler.GetHeightMapBase64(heightMapLocation);
    }
    else
    {
        Console.WriteLine("DSM File not found");
    }
  }

  /// <summary>
  /// Navigate to register page
  /// </summary>
  void Register()
  {
    loadingService.ShowLoadingScreen();
    NavigationManager.NavigateTo("/register");
  }
}