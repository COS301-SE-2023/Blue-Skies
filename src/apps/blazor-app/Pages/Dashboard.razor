@page "/dashboard"
@layout MainLayout
@using BlazorApp.Components.Base
@using BlazorApp.Components.Dashboard
@using BlazorApp.Components
@using BlazorApp.Models
@using System.Text.Json
@using ChartJs.Blazor.PieChart
@using ChartJs.Blazor.PolarAreaChart
@inject BlazorApp.Data.LoadingService loadingService
@inject BlazorApp.Data.ReportManager reportManager
@inject ProtectedLocalStorage ProtectedLocalStore
@inject ProtectedSessionStorage ProtectedSessionStore
@inject NavigationManager NavigationManager
@inject BlazorApp.Data.LoadingService loadingService


<PageTitle>Dashboard - Blue Skies</PageTitle>

@if (!isLoaded) { }
else if (!logIn)
{
    ProtectedSessionStore.SetAsync("redirect", "dashboard");
    loadingService.ShowLoadingScreen();
    NavigationManager.NavigateTo("/login");
}
else if (isAd)
{
    loadingService.ShowLoadingScreen();
    NavigationManager.NavigateTo("/admin/keys");
}
else
{
    <div class="fade-in-active px-1 md:px-5">
        @if (reports.Count > 0)
        {
            <div class="flex flex-col justify-center items-center px-10">
                @{
                    if (reports.Count > selectedReport)
                    {
                        selectedDate = reports[selectedReport].dateCreated;
                    }
                }
                <SelectCalculation @bind-selectedReport="selectedReport" userReports="reports" dateCreated="selectedDate" />
                @{
                    var image = "";
                    if (reports.Count > selectedReport)
                    {
                        image = reports[selectedReport].image;
                    }
                }
                <LocationInfo css="mt-8" selectedReport="selectedReport" basicCalculationImage="@image" systems="systems" />
                <div class="mt-10 w-full">
                    <Card>
                        <Heading>
                            <Header>
                                <h1 class="text-xl">Appliances</h1>
                            </Header>
                            <Subscript>
                                <p>What do you want to run in a power outage?</p>
                            </Subscript>
                        </Heading>
                        <div class="p-10 justify-start flex flex-col rounded-3xl w-full">
                            <div class="grid grid-cols-2 md:flex gap-4 justify-evenly scale-90">
                                @{
                                    updateAppliances();
                                    for (int i = 0; i < reportAllAppliance.Count; i++)
                                    {
                                        if (reportAllAppliance[i].numberOfAppliances != 0)
                                        {
                                            var appliance = reportAllAppliance[i].type;
                                            var count = reportAllAppliance[i].numberOfAppliances;
                                            string iconName = appliance + ".svg";
                                            <Appliance ImageName="@iconName" Name="@appliance" Count="@count" />
                                        }
                                    }
                                    if (reportAllAppliance.Count == 0)
                                    {
                                        <p class="text-center">No appliances added</p>
                                    }
                                }
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row w-full mt-0 md:mt-5">
                            <div class="w-full flex flex-col gap-4 justify-start items-center">
                                <h3 class="font-medium text-lg text-primary-900 text-left">Running Hours</h3>
                                <div class="flex relative flex-col justify-center w-full">
                                    <Chart Config="pieConfig"></Chart>
                                    <div class="flex w-full justify-center absolute top-1/2 left-0 items-center gap-1 mt-20">
                                        <p class="text-5xl text-primary-900 font-semibold">
                                            @reports[selectedReport].daylightHours</p>
                                        <p class="text-5xl text-gray-400 font-bold">h</p>
                                    </div>
                                </div>
                            </div>
                            <div class="hidden md:block w-full">
                                @{
                                    var imageName = "";
                                    if (reports.Count > selectedReport)
                                    {
                                        var sysId = reports[selectedReport].systemId;
                                        var sysSize = "Small";
                                        foreach (var sys in systems)
                                        {
                                            if (sys.systemId == sysId)
                                            {
                                                sysSize = sys.systemSize;
                                            }
                                        }
                                        if (sysSize != null)
                                        {
                                            if (sysSize.Equals("Small"))
                                            {
                                                imageName = "House 3.svg";
                                            }
                                            else if (sysSize.Equals("Medium"))
                                            {
                                                imageName = "House 2.svg";
                                            }
                                            else
                                            {
                                                imageName = "House 1.svg";
                                            }
                                        }
                                    }
                                }
                                <Image ImageName=@imageName alt="House" css="scale-90" />
                            </div>
                            <div class="w-full mt-32 md:mt-0 flex flex-col gap-4 justify-start items-center">
                                <h3 class="font-medium text-md text-primary-900 text-left">Appliance Energy Consumption</h3>
                                @* <div class="flex items-center text-left gap-2">
                        <div class="w-2 h-2 bg-primary-400 rounded-full"></div>
                        <p class="">High Energy Consumption</p>
                        </div> *@
                                <div class="flex relative flex-col justify-center w-full">
                                    <Chart Config="polarAreaConfig"></Chart>
                                </div>
                            </div>
                        </div>
                    </Card>
                </div>
            </div>

        }
        else
        {
            <div class="flex flex-col justify-center items-center px-10 mt-10">
                <div class="flex flex-col justify-center items-center">
                    <h1 class="text-4xl font-medium text-primary-900">No Reports</h1> <br />
                    <p class="text-center">You have no reports. Create a report to get started.</p>
                </div>
                <div class="mt-10 flex flex-col sm:flex-row items-center justify-center gap-6">
                    <Button style="pill" css="h-14">
                        <content>
                            <p @onclick='() => CreateReport()' class="text-sm font-semibold hover:text-white">Create a Report </p>
                        </content>
                    </Button>
                </div>
            </div>
        }
    </div>

    <ModalPopup @ref="ModalPopup" Title="Delete Record?">
        <ChildContent>
            <p>Are you sure that you want to delete this record?</p>
            <div class="flex flex-row gap-4 justify-center">
                <div @onclick="Delete">
                    <Button style="danger">
                        <content>
                            delete
                        </content>
                    </Button>
                </div>
                <div @onclick="ModalPopup.Dismiss">
                    <Button style="outline-danger">
                        <content>Cancel</content>
                    </Button>
                </div>
            </div>
        </ChildContent>
    </ModalPopup>
   
}



@code {
    private string? API_PORT = Environment.GetEnvironmentVariable("API_PORT");
    private List<ReportModel> reports = new List<ReportModel>();
    private List<ReportAllApplianceModel> allReportAllAppliance = new List<ReportAllApplianceModel>();
    private List<ReportAllApplianceModel> reportAllAppliance = new List<ReportAllApplianceModel>();
    private List<SystemModel> systems = new List<SystemModel>();
    private bool isLoaded = false;
    private bool logIn = false;
    private bool isAd = false;
    private int userId = -1;
    private int selectedReport = 0;
    private DateTime selectedDate;
    private PieConfig pieConfig = new PieConfig();
    private PolarAreaConfig polarAreaConfig = new PolarAreaConfig();
    private ReportModel report = new ReportModel();
    private ModalPopup ModalPopup { get; set; } = new ModalPopup();

    protected override async Task OnInitializedAsync()
    {
        var loggedIn = await ProtectedLocalStore.GetAsync<bool>("loggedIn");
        var isAdmin = await ProtectedLocalStore.GetAsync<bool>("isAdmin");
        var usId = await ProtectedLocalStore.GetAsync<int>("userId");
        logIn = loggedIn.Value;
        isAd = isAdmin.Value;
        userId = usId.Value;

        await GetSystemsAsync();       
        await GetUserReports();
        Console.WriteLine("Reports: " + reports.Count);
        if (reports.Count > 0)
        {
            await GetReportAllAppliance();
            await ProtectedSessionStore.SetAsync("currentReport", reports[selectedReport]);
            updateAppliances();
            renderCharts();
        }
        reportManager.EditReportRequested += Edit;
        reportManager.DeleteReportRequested += ShowModal;
        loadingService.HideLoadingScreen();
        isLoaded = true;
    }

    private async Task GetSystemsAsync()
    {
        var client = new HttpClient();
        var request = new HttpRequestMessage(HttpMethod.Get, API_PORT + "/System/all");
        var response = await client.SendAsync(request);
        if (response.StatusCode == System.Net.HttpStatusCode.OK)
        {
            var data = await response.Content.ReadAsStringAsync();
            systems = JsonSerializer.Deserialize<List<SystemModel>>(data, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive =
                true
                })!;
            if (systems.Count > 0)
            {
                await ProtectedSessionStore.SetAsync("systems", systems);
            }
        }
        else
        {
            Console.WriteLine("Failed");
        }
    }
    private void Dispose() {
        reportManager.EditReportRequested -= Edit;
        reportManager.DeleteReportRequested -= ShowModal;
    }
    private async void updateAppliances()
    {
        reportAllAppliance.Clear();
        if (reports.Count > 0)
        {
            int reportId = reports[selectedReport].reportId;
            foreach (var reportAllApp in allReportAllAppliance)
            {
                if (reportAllApp.reportId == reportId)
                {
                    reportAllAppliance.Add(reportAllApp);
                }
            }
            updateCharts();
        }
        await ProtectedSessionStore.SetAsync("userReportAllAppliance", reportAllAppliance);
    }
    private async Task GetUserReports()
    {
        var client = new HttpClient();
        var request = new HttpRequestMessage(HttpMethod.Get, API_PORT + "/Report/getUserReports/" + userId);
        var response = await client.SendAsync(request);
        if (response.StatusCode == System.Net.HttpStatusCode.OK)
        {
            var data = await response.Content.ReadAsStringAsync();
            reports = JsonSerializer.Deserialize<List<ReportModel>>(data, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                })!;
            if (reports.Count > 0)
            {
                await ProtectedSessionStore.SetAsync("userReports", reports);
            }
            Console.WriteLine("Successfully retrieved user reports");
        }
        else
        {
            Console.WriteLine("Failed to get user reports");
        }
    }
    private async Task GetReportAllAppliance()
    {
        var client = new HttpClient();
        var request = new HttpRequestMessage(HttpMethod.Get, API_PORT + "/ReportAllAppliance/all");
        var response = await client.SendAsync(request);
        if (response.StatusCode == System.Net.HttpStatusCode.OK)
        {
            var data = await response.Content.ReadAsStringAsync();
            allReportAllAppliance = JsonSerializer.Deserialize<List<ReportAllApplianceModel>>(data, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                })!;
            if (allReportAllAppliance.Count > 0)
            {
                await ProtectedSessionStore.SetAsync("userReportAllAppliance", allReportAllAppliance);
            }
        }
        else
        {
            Console.WriteLine("Failed to get allReportAllAppliance");
        }
    }
    private void renderCharts()
    {
        @* **************************************** Pie Chart Config ************************************************ *@
        pieConfig = new PieConfig(true)
            {
                Options = new PieOptions
                {
                    Responsive = true,
                    AspectRatio = 3,
                    Legend = new Legend
                    {
                        Display = false,
                    },
                    Title = new OptionsTitle
                    {
                        Display = false,
                        Text = "Running Hours",
                        FontSize = 20,
                        Position = Position.Bottom,
                        LineHeight = 4,
                    },
                    Circumference = 3,
                    Rotation = -9.341,
                    Animation = new ArcAnimation
                    {
                        AnimateRotate = true,
                        Duration = 2000,

                    },
                    Tooltips = new Tooltips
                    {
                        Enabled = true,
                        Mode = InteractionMode.Index,
                        Intersect = false,
                    },
                    Hover = new Hover
                    {
                        Mode = InteractionMode.Index,
                        Intersect = false
                    },
                    CutoutPercentage = 80
                }
            };

        @* **************************************** Polar Area Chart Config ************************************************ *@
        polarAreaConfig = new PolarAreaConfig()
            {
                Options = new PolarAreaOptions
                {
                    Responsive = true,
                    AspectRatio = 1.5,
                    Legend = new Legend
                    {
                        Display = false,
                    },
                    Animation = new ArcAnimation
                    {
                        AnimateRotate = true,
                        Duration = 2000,

                    },
                    Tooltips = new Tooltips
                    {
                        Enabled = true,
                        Mode = InteractionMode.Index,
                        Intersect = false
                    },
                    Hover = new Hover
                    {
                        Mode = InteractionMode.Index,
                        Intersect = false
                    },
                    Scale = new LinearRadialAxis
                    {
                        Ticks = new LinearRadialTicks
                        {
                            Display = false,
                        }
                    }

                }
            };
        updateCharts();
    }
    private void updateCharts()
    {
        @* **************************************** Pie Chart Update Data ************************************************ *@
        pieConfig.Data.Datasets.Clear();

        foreach (string color in new[] { "Runnable Hours", "Remaining" })
        {
            pieConfig.Data.Labels.Add(color);
        }
        if (reports.Count > 0)
        {
            float hours = reports[selectedReport].daylightHours;
            float remaining = (float)Math.Round(13 - hours, 2);
            PieDataset<float> pieDataset = new PieDataset<float>(new[] { hours, remaining, })
                {
                    BackgroundColor = new[] {
                        ColorUtil.ColorHexString(56,113,193),
                        ColorUtil.ColorHexString(156,163,175),
                    },
                };
            if (pieConfig != null)
            {
                pieConfig.Data.Datasets.Add(pieDataset);
            }
        }


        @* **************************************** Polar Area Chart Update Data
************************************************ *@

        polarAreaConfig.Data.Datasets.Clear();
        polarAreaConfig.Data.Labels.Clear();
        int countData = 0;
        for (int i = 0; i < reportAllAppliance.Count; i++)
        {
            if (reportAllAppliance[i].numberOfAppliances != 0)
            {
                countData++;
            }
        }

        int[] powerUsageData = new int[countData];
        int counter = 0;
        for (int i = 0; i < reportAllAppliance.Count; i++)
        {
            if (reportAllAppliance[i].numberOfAppliances != 0)
            {
                powerUsageData[counter] = reportAllAppliance[i].numberOfAppliances * reportAllAppliance[i].powerUsage;
                polarAreaConfig.Data.Labels.Add(reportAllAppliance[i].type);
                counter++;
            }
        }
        PolarAreaDataset<int> polarDataset;
        switch (counter)
        {
            case 0:
                polarDataset = new PolarAreaDataset<int>(powerUsageData)
                    {
                        BackgroundColor = new[] {
                            ColorUtil.ColorHexString(0,15,82),
                        }
                    };
                break;
            case 1:
                polarDataset = new PolarAreaDataset<int>(powerUsageData)
                    {
                        BackgroundColor = new[] {
                            ColorUtil.ColorHexString(0,15,82),
                        }
                    };
                break;
            case 2:
                polarDataset = new PolarAreaDataset<int>(powerUsageData)
                    {
                        BackgroundColor = new[] {
                            ColorUtil.ColorHexString(56,113,193),
                            ColorUtil.ColorHexString(0,15,82),
                        }
                    };
                break;
            case 3:
                polarDataset = new PolarAreaDataset<int>(powerUsageData)
                    {
                        BackgroundColor = new[] {
                            ColorUtil.ColorHexString(255,193,8),
                            ColorUtil.ColorHexString(56,113,193),
                            ColorUtil.ColorHexString(0,15,82),
                        }
                    };
                break;
            case 4:
                polarDataset = new PolarAreaDataset<int>(powerUsageData)
                    {
                        BackgroundColor = new[] {
                            ColorUtil.ColorHexString(246,135,18),
                            ColorUtil.ColorHexString(255,193,8),
                            ColorUtil.ColorHexString(56,113,193),
                            ColorUtil.ColorHexString(0,15,82),
                        }
                    };
                Console.WriteLine("4");
                break;
            case 5:
                polarDataset = new PolarAreaDataset<int>(powerUsageData)
                    {
                        BackgroundColor = new[] {
                            ColorUtil.ColorHexString(0,15,82),
                            ColorUtil.ColorHexString(246,135,18),
                            ColorUtil.ColorHexString(255,193,8),
                            ColorUtil.ColorHexString(56,113,193),
                            ColorUtil.ColorHexString(0,15,82),
                        }
                    };
                break;
            case 6:
                polarDataset = new PolarAreaDataset<int>(powerUsageData)
                    {
                        BackgroundColor = new[] {
                            ColorUtil.ColorHexString(246,135,18),
                            ColorUtil.ColorHexString(0,15,82),
                            ColorUtil.ColorHexString(246,135,18),
                            ColorUtil.ColorHexString(255,193,8),
                            ColorUtil.ColorHexString(56,113,193),
                            ColorUtil.ColorHexString(0,15,82),
                        }
                    };
                break;
            case 7:
                polarDataset = new PolarAreaDataset<int>(powerUsageData)
                    {
                        BackgroundColor = new[] {
                            ColorUtil.ColorHexString(246,135,18),
                            ColorUtil.ColorHexString(56,113,193),
                            ColorUtil.ColorHexString(0,15,82),
                            ColorUtil.ColorHexString(246,135,18),
                            ColorUtil.ColorHexString(255,193,8),
                            ColorUtil.ColorHexString(56,113,193),
                            ColorUtil.ColorHexString(0,15,82),
                        }
                    };
                break;
            case 8:
                polarDataset = new PolarAreaDataset<int>(powerUsageData)
                    {
                        BackgroundColor = new[] {
                        ColorUtil.ColorHexString(246,135,18),
                        ColorUtil.ColorHexString(255,193,8),
                        ColorUtil.ColorHexString(56,113,193),
                        ColorUtil.ColorHexString(0,15,82),
                        ColorUtil.ColorHexString(246,135,18), // orange
                        ColorUtil.ColorHexString(255,193,8), // yellow
                        ColorUtil.ColorHexString(56,113,193),// l blue
                        ColorUtil.ColorHexString(0,15,82), // blue
                        }
                    };
                break;
            default:
                polarDataset = new PolarAreaDataset<int>(powerUsageData)
                    {
                        BackgroundColor = new[] {
                            ColorUtil.ColorHexString(0,15,82), // Slice 1 aka "Red"
                        }
                    };
                break;
        }
        if (polarAreaConfig != null)
        {
            polarAreaConfig.Data.Datasets.Add(polarDataset);
        }
    }
    private Task CreateReport()
    {
        loadingService.ShowLoadingScreen();
        NavigationManager.NavigateTo("/advanced");
        return Task.CompletedTask;
    }
    private void ShowModal()
    {
        ModalPopup.Show();
        StateHasChanged();
        Console.WriteLine("Modal shown");
    }
    private async void Edit()
    {
        loadingService.ShowLoadingScreen();
        await ProtectedSessionStore.SetAsync("edit", true);
        NavigationManager.NavigateTo("/advanced");
        StateHasChanged();
    }
     private async Task Delete(){

        ModalPopup.Dismiss();
        await DeleteFromDatabase();

        NavigationManager.NavigateTo("/dashboard", true);
    }

    private async Task DeleteFromDatabase()
    {
        var client = new HttpClient();
        var request = new HttpRequestMessage(HttpMethod.Delete, API_PORT + "/Report/delete");

        var repId = await ProtectedSessionStore.GetAsync<ReportModel>("currentReport");
        report = repId.Value!;
        Console.WriteLine(report!.reportId);

        var content = new StringContent("{\r\n \"reportId\": " + report.reportId + "\r\n}", null, "application/json");
        request.Content = content;
        var response = await client.SendAsync(request);
        if (response.StatusCode == System.Net.HttpStatusCode.OK)
        {
            Console.WriteLine("Report succesfully deleted");
        }
        else
        {
            Console.WriteLine("Failed to delete report");
        }
    }
}
