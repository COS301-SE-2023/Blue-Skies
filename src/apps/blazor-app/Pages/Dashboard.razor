@page "/dashboard"
@layout MainLayout
@using BlazorApp.Components.Base
@using BlazorApp.Components.Dashboard
@using BlazorApp.Models
@using System.Text.Json
@using ChartJs.Blazor.PieChart
@inject ProtectedLocalStorage ProtectedLocalStore
@inject NavigationManager NavigationManager

<PageTitle>Dashboard - Blue Skies</PageTitle>

<div class="fade-in-enter-active">
    @if (!isLoaded) { }
    else if (!logIn)
    {
        ProtectedLocalStore.SetAsync("redirect", "dashboard");
        NavigationManager.NavigateTo("/login");
    }
    else if (isAd)
    {
        NavigationManager.NavigateTo("/admin/keys");
    }
    else
    {
        @if (reports.Count > 0)
        {
        <div class="flex flex-col justify-center items-center px-10">
            @{
                selectedDate = reports[selectedReport].dateCreated;
            }
            <SelectCalculation @bind-selectedReport="selectedReport" userReports="userReportNames"
                dateCreated="selectedDate" />
            <LocationInfo css="mt-8" selectedReport="selectedReport" reportAll="reportAll" />
            <div class="mt-10 w-full">
                <Card>
                    <Heading>
                        <Header>
                            <h1 class="text-xl">Appliances</h1>
                        </Header>
                        <Subscript>
                            <p>What do you want to run in a power outage?</p>
                        </Subscript>
                    </Heading>
                    <div class="p-10 justify-start flex flex-col rounded-3xl w-full">
                        <div class="flex gap-4 justify-evenly scale-90">
                            @{
                                updateAppliances();
                                for (int i = 0; i < reportAllAppliance.Count; i++)
                                {
                                    var appliance = reportAllAppliance[i].type;
                                    var count = reportAllAppliance[i].numberOfAppliances;
                                    string iconName = appliance + ".svg";
                                    <Appliance ImageName="@iconName" Name="@appliance" Count="@count" />
                                }
                                if (reportAllAppliance.Count == 0)
                                {
                                    <p class="text-center">No appliances added</p>
                                }
                            }
                        </div>
                    </div>
                    <div class="flex w-full mt-5">
                        <div class="w-full flex flex-col gap-4 justify-start items-center">
                            <h3 class="font-medium text-lg text-primary-900 text-left">Running Hours</h3>
                            <div class="flex items-center text-left gap-2">
                                <div class="w-2 h-2 bg-primary-500 rounded-full"></div>
                                <p class="">Usable Sunlight</p>
                            </div>
                            <div class="flex relative flex-col justify-center w-full">
                                <Chart Config="pieConfig"></Chart>
                                <div class="flex w-full justify-center absolute top-1/2 left-0 items-center gap-1 mt-4">
                                        <p class="text-5xl text-primary-900 font-semibold">5</p>
                                        <p class="text-5xl text-gray-400 font-bold">h</p>
                                </div>
                            </div>
                        </div>
                        <div class="w-full">
                            @{
                                var imageName = "";
                                var sysSize = reportAll[selectedReport].systemSize;
                                if (sysSize != null)
                                {
                                    if (sysSize.Equals("Small"))
                                    {
                                        imageName = "House 3.svg";
                                    }
                                    else if (sysSize.Equals("Medium"))
                                    {
                                        imageName = "House 2.svg";
                                    }
                                    else if (sysSize.Equals("Large"))
                                    {
                                        imageName = "House 1.svg";
                                    }
                                }
                            }
                            <Image ImageName=@imageName alt="House" css="scale-90" />
                        </div>
                        <div class="w-full flex flex-col gap-4 justify-start items-center">
                            <h3 class="font-medium text-md text-primary-900 text-left">Appliance Energy Consumption</h3>
                            <div class="flex items-center text-left gap-2">
                                <div class="w-2 h-2 bg-primary-400 rounded-full"></div>
                                <p class="">High Energy Consumption</p>
                            </div>
                            <svg width="222" height="222" viewBox="0 0 222 222" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M111 221.372C171.751 221.372 221 172.123 221 111.372C221 50.6203 171.751 1.37158 111 1.37158C50.2487 1.37158 1 50.6203 1 111.372C1 172.123 50.2487 221.372 111 221.372Z"
                                    stroke="#C1C7CD" />
                                <path
                                    d="M111 199.372C159.601 199.372 199 159.973 199 111.372C199 62.7705 159.601 23.3716 111 23.3716C62.3989 23.3716 23 62.7705 23 111.372C23 159.973 62.3989 199.372 111 199.372Z"
                                    stroke="#C1C7CD" />
                                <path
                                    d="M111 177.372C147.451 177.372 177 147.822 177 111.372C177 74.9208 147.451 45.3716 111 45.3716C74.5492 45.3716 45 74.9208 45 111.372C45 147.822 74.5492 177.372 111 177.372Z"
                                    stroke="#C1C7CD" />
                                <path
                                    d="M111 155.372C135.301 155.372 155 135.672 155 111.372C155 87.0711 135.301 67.3716 111 67.3716C86.6995 67.3716 67 87.0711 67 111.372C67 135.672 86.6995 155.372 111 155.372Z"
                                    stroke="#C1C7CD" />
                                <path
                                    d="M111 133.372C123.15 133.372 133 123.522 133 111.372C133 99.2213 123.15 89.3716 111 89.3716C98.8497 89.3716 89 99.2213 89 111.372C89 123.522 98.8497 133.372 111 133.372Z"
                                    stroke="#C1C7CD" />
                                <path
                                    d="M199.159 72.7442C204.354 84.601 207.104 97.3839 207.244 110.328C207.385 123.272 204.912 136.112 199.976 148.079C195.039 160.045 187.739 170.893 178.512 179.973C169.286 189.053 158.323 196.178 146.278 200.923L111 111.372L199.159 72.7442Z"
                                    fill="#3871C1" stroke="white" />
                                <path
                                    d="M18.9185 83.3527C24.9017 63.6895 37.0222 46.4579 53.5057 34.1805C69.9892 21.903 89.97 15.2246 110.523 15.1228L111 111.372L18.9185 83.3527Z"
                                    fill="#3871C1" stroke="white" />
                                <path
                                    d="M110.624 36.9282C125.07 36.9282 139.201 41.1528 151.277 49.0818C163.353 57.0108 172.846 68.2981 178.589 81.5541L110.624 110.996L110.624 36.9282Z"
                                    fill="#75CDF7" stroke="white" />
                                <path
                                    d="M137.866 179.871C125.643 184.706 112.354 186.2 99.3632 184.202C86.3721 182.204 74.1468 176.784 63.9421 168.5L110.624 110.996L137.866 179.871Z"
                                    fill="#A0D3FE" stroke="white" />
                                <path
                                    d="M88.5619 137.905C83.2326 133.555 79.3119 127.723 77.2951 121.146C75.2782 114.569 75.2556 107.542 77.2301 100.952L110.57 110.942L88.5619 137.905Z"
                                    fill="#E0EEFE" stroke="white" />
                            </svg>
                        </div>
                    </div>
                </Card>
            </div>
        </div>
    
    }else {
        <div class="flex flex-col justify-center items-center px-10">
            <div class="flex flex-col justify-center items-center">
                <h1 class="text-4xl font-medium text-primary-900">No Reports</h1> <br/>
                <p class="text-center">You have no reports. Create a report to get started.</p>
            </div>
            <div class="mt-10 flex flex-col sm:flex-row items-center justify-center gap-6">
            <Button style="pill" css="h-14">
                <content>
                    <p @onclick='() => NavigationManager.NavigateTo("/advanced")' class="text-sm font-semibold hover:text-white">Create a Report</p>
                </content>
            </Button>
            </div>
        </div>
    }
    }
</div>
@code {
    private string? API_PORT = Environment.GetEnvironmentVariable("API_PORT");
    private List<ReportModel> reports = new List<ReportModel>();
    private List<string> userReportNames = new List<string>();
    private List<ReportAllModel> reportAll = new List<ReportAllModel>();
    private List<ReportAllApplianceModel> allReportAllAppliance = new List<ReportAllApplianceModel>();
    private List<ReportAllApplianceModel> reportAllAppliance = new List<ReportAllApplianceModel>();

    private bool isLoaded = false;
    private bool logIn = false;
    private bool isAd = false;
    private int userId = -1;
    private int selectedReport;
    private DateTime selectedDate;
    private PieConfig pieConfig = new PieConfig();

    protected override async Task OnInitializedAsync()
    {
        var loggedIn = await ProtectedLocalStore.GetAsync<bool>("loggedIn");
        var isAdmin = await ProtectedLocalStore.GetAsync<bool>("isAdmin");
        var usId = await ProtectedLocalStore.GetAsync<int>("userId");
        logIn = loggedIn.Value;
        isAd = isAdmin.Value;
        isLoaded = true;
        userId = usId.Value;

        await GetUserReports();
        await GetReportAll();
        await GetReportAllAppliance();
        renderCharts();
    }

    private void updateAppliances()
    {
        reportAllAppliance.Clear();
        int reportId = reportAll[selectedReport].reportId;
        foreach (var reportAllApp in allReportAllAppliance)
        {
            if (reportAllApp.reportId == reportId)
            {
                reportAllAppliance.Add(reportAllApp);
            }
        }
    }

    private async Task GetUserReports()
    {
        var client = new HttpClient();
        var request = new HttpRequestMessage(HttpMethod.Get, API_PORT + "/Report/getUserReports/" + userId);
        var response = await client.SendAsync(request);
        if (response.StatusCode == System.Net.HttpStatusCode.OK)
        {
            var data = await response.Content.ReadAsStringAsync();
            reports = JsonSerializer.Deserialize<List<ReportModel>>(data, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive =
                true
                })!;
            if (reports.Count > 0)
            {
                await ProtectedLocalStore.SetAsync("userReports", reports);
            }
        }
        else
        {
            Console.WriteLine("Failed to get user reports");
        }
    }

    private async Task GetReportAll()
    {
        var client = new HttpClient();
        var request = new HttpRequestMessage(HttpMethod.Get, API_PORT + "/ReportAll/user/" + userId);
        var response = await client.SendAsync(request);
        if (response.StatusCode == System.Net.HttpStatusCode.OK)
        {
            var data = await response.Content.ReadAsStringAsync();
            reportAll = JsonSerializer.Deserialize<List<ReportAllModel>>(data, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive =
                true
                })!;
            if (reportAll.Count > 0)
            {
                await ProtectedLocalStore.SetAsync("reportAll", reportAll);
            }
            foreach (var report in reportAll)
            {
                userReportNames.Add(report.reportName!);
            }
        }
        else
        {
            Console.WriteLine("Failed to get report all");
        }
    }

    private async Task GetReportAllAppliance()
    {
        var client = new HttpClient();
        var request = new HttpRequestMessage(HttpMethod.Get, API_PORT + "/ReportAllAppliance/all");
        var response = await client.SendAsync(request);
        if (response.StatusCode == System.Net.HttpStatusCode.OK)
        {
            var data = await response.Content.ReadAsStringAsync();
            allReportAllAppliance = JsonSerializer.Deserialize<List<ReportAllApplianceModel>>(data, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive =
                true
                })!;
            if (allReportAllAppliance.Count > 0)
            {
                await ProtectedLocalStore.SetAsync("userReportAllAppliance", allReportAllAppliance);
            }
        }
        else
        {
            Console.WriteLine("Failed to get allReportAllAppliance");
        }
    }

    private void renderCharts() {
        pieConfig = new PieConfig(true) {
                Options = new PieOptions
                {
                    Responsive = true,
                    AspectRatio = 3,
                    Legend = new Legend
                    {
                        Display = false,
                    },
                    Title = new OptionsTitle
                    {
                        Display = false,
                        Text = "Running Hours",
                        FontSize = 20,
                        Position = Position.Bottom,
                        LineHeight = 4,
                    },
                    Circumference = 3,
                    Rotation = -9.341,
                    Animation = new ArcAnimation
                    {
                        AnimateRotate = true,
                        Duration = 2000,

                    },
                    Tooltips = new Tooltips
                    {
                        Enabled = true,
                        Mode = InteractionMode.Index,
                        Intersect = false
                    },
                    Hover = new Hover
                    {
                        Mode = InteractionMode.Index,
                        Intersect = false
                    },
                    CutoutPercentage = 80
                }
            };
            

        foreach (string color in new[] { "Runnable Hours", "Remaining" })
        {
            pieConfig.Data.Labels.Add(color);
        }

        PieDataset<int> dataset = new PieDataset<int>(new[] { 5, 7,})
        {
            BackgroundColor = new[] {
                ColorUtil.ColorHexString(56, 113, 193),
                ColorUtil.ColorHexString(217, 217, 217),
            },
        };
        if (pieConfig != null)
        {
            pieConfig.Data.Datasets.Add(dataset);
        }
    }
}
