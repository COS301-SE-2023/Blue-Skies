@using BlazorApp.Models
@using System.Text.Json
@using Newtonsoft.Json
@using BlazorApp.Components.Base


@* Namespace chatbot *@
@namespace BlazorApp.Chatbot

<div class="mx-auto">
  <div class="w-fit mx-auto text-center mb-14">
    <Heading>
      <Header>
        <h1 class="text-4xl font-bold tracking-tight text-primary-950 md:text-5xl">Still have a Question?</h1>
      </Header>
      <Subscript>
        <h1 class="mt-4">Discover answers to common solar energy questions.</h1>
      </Subscript>
    </Heading>
  </div>
  <div class="mx-auto p-3 rounded-lg w-full md:w-1/2 xl:w-1/3">
    <div class="">
      <div class="w-fit mx-auto flex space-x-4">
        <div class="flex items-center">
          <Image ImageName="Logo-small.svg" css="h-12 w-12" alt="Logo" />
          <h1 class="text-2xl text-blue-500">Ask me Anything!</h1>
        </div>
        <Image ImageName="Robert_Sitting_Panel.png" css="h-20 w-20" alt="Robert sitting on panel" />
      </div>

      <div class="w-full space-y-2 my-3">
        @foreach (Message mess in _conversationHistory)
        {
        <div>
          @if (mess.role == "user")
          {
          <div class="ml-auto text-white w-fit rounded-lg bg-blue-500 p-2">
            @mess.content
          </div>
          }
          else if (mess.role != "system")
          {
          <div class="mr-auto text-black w-fit rounded-lg bg-blue-200 p-2">
            @mess.content
          </div>
          }
        </div>
        }
      </div>
    </div>
    <div class="mt-3 flex space-x-2 items-center">
      <input type="text" id="message" rows="1"
        class="block w-full rounded-md border-0 py-1.5 pl-7 pr-20 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
        placeholder="Do you have any questions for us?" @bind-value="_userQuestion" @bind-value:event="oninput"
        @onkeypress="HandleKeyPress" />
      <div @onclick="SendMessage">
          <Button style="pill">
              <content>
                  <p class="text-sm font-semibold hover:text-white">Send</p>
              </content>
          </Button>
      </div>
    </div>
  </div>
</div>




@code {

  private string? API_PORT = Environment.GetEnvironmentVariable("API_PORT");
  private string _userQuestion = string.Empty;
  private readonly List<Message> _conversationHistory = new();
  private readonly string _chatBotKnowledgeScope = "" +
  "Your name is Robert, You are an assistant that help users navigate and use a website called Blue Skies" +
  "When user's question is not related to solar or BlueSkies, reply repond with \"Do you have questions on Blue Skies?\"" + 
  "A solar score measures your property's solar potential based on sunlight availability, shading, and local weather patterns. It estimates of solar panels in generating electricity for your location. "+
  "The appliances you can run on solar depend on system size. Small setups may power lights, fans, laptops, and smartphones. Larger ones can run refrigerators, air conditioners, washers, and EVs."+
  "Solar panels offer renewable energy, reduced bills, eco-friendliness, energy independence, incentives, and low maintenance." +
  "Will solar panels work during cloudy or rainy days? Yes, they work but with reduced efficiency. They generate power from sunlight, even on overcast days, though less than under direct sunlight."+
  "How much money can I save by using solar energy? Savings vary by location, panel size, electricity rates, and incentives. Long-term, solar can substantially lower bills and may lead to surplus energy sales."+
  "Hiring a professional installer is strongly recommended as they ensure safety, handle permits, and maintain warranties, providing peace of mind for your solar panel installation.";
  private string chatbotApiKey = "";
  private SharedUtils.locationDataClass locationDataClass = new SharedUtils.locationDataClass();
  protected override async Task OnInitializedAsync()
  {
    chatbotApiKey = await locationDataClass.GetChatbotApiKey();
    _conversationHistory.Add(new Message { role = "system", content = _chatBotKnowledgeScope });
    _conversationHistory.Add(new Message { role = "assistant", content = "Hi! I'm Robert. Ask me Anything!" });
    @* return base.OnInitializedAsync(); *@
  }
  private async Task HandleKeyPress(KeyboardEventArgs e)
  {
    if (e.Key is not "Enter") return;
    await SendMessage();
  }

  private async Task SendMessage()
  {
    if (string.IsNullOrWhiteSpace(_userQuestion)) return;
    AddUserQuestionToConversation();
    StateHasChanged();
    ClearInput();
    await CreateCompletion();
    StateHasChanged();
  }

  private void AddUserQuestionToConversation()
  => _conversationHistory.Add(new Message { role = "user", content = _userQuestion });


  private async Task CreateCompletion()
  {
    var postData = new
    {
      model = "gpt-3.5-turbo",
      messages = _conversationHistory.ToArray(),
    };

    string jsonContent = JsonConvert.SerializeObject(postData);

    var client = new HttpClient();
    var request = new HttpRequestMessage(HttpMethod.Post, "https://api.openai.com/v1/chat/completions");
    request.Headers.Add("Authorization", "Bearer " + chatbotApiKey);
    var content = new StringContent(jsonContent, null, "application/json");
    request.Content = content;
    var response = await client.SendAsync(request);
    if (response.IsSuccessStatusCode)
    {
      var chatCompletionResponse = await response.Content.ReadFromJsonAsync<ChatbotResponse>();
      Message? temp = chatCompletionResponse!.choices!.First().message;
      _conversationHistory.Add(temp!);
    }
    else
    {
      _conversationHistory.Add(new Message { role = "assitant", content = "Sorry, I don't know the answer that." });
    }



  }

  private void ClearInput()
  {
    _userQuestion = string.Empty;

  }
}
